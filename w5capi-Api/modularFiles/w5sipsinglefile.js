/*single file for sip related operation*/
!function(e){"use strict";function o(){}function t(e,o){if(a)return o.indexOf(e);for(var t=o.length;t--;)if(o[t]===e)return t;return-1}var n=o.prototype,a=Array.prototype.indexOf?!0:!1;n._getEvents=function(){return this._events||(this._events={})},n.getListeners=function(e){var o,t,n=this._getEvents();if("object"==typeof e){o={};for(t in n)n.hasOwnProperty(t)&&e.test(t)&&(o[t]=n[t])}else o=n[e]||(n[e]=[]);return o},n.getListenersAsObject=function(e){var o,t=this.getListeners(e);return t instanceof Array&&(o={},o[e]=t),o||t},n.addListener=function(e,o){var n,a=this.getListenersAsObject(e);for(n in a)a.hasOwnProperty(n)&&-1===t(o,a[n])&&a[n].push(o);return this},n.on=n.addListener,n.defineEvent=function(e){return this.getListeners(e),this},n.defineEvents=function(e){for(var o=0;o<e.length;o+=1)this.defineEvent(e[o]);return this},n.removeListener=function(e,o){var n,a,r=this.getListenersAsObject(e);for(a in r)r.hasOwnProperty(a)&&(n=t(o,r[a]),-1!==n&&r[a].splice(n,1));return this},n.off=n.removeListener,n.addListeners=function(e,o){return this.manipulateListeners(!1,e,o)},n.removeListeners=function(e,o){return this.manipulateListeners(!0,e,o)},n.manipulateListeners=function(e,o,t){var n,a,r=e?this.removeListener:this.addListener,s=e?this.removeListeners:this.addListeners;if("object"!=typeof o||o instanceof RegExp)for(n=t.length;n--;)r.call(this,o,t[n]);else for(n in o)o.hasOwnProperty(n)&&(a=o[n])&&("function"==typeof a?r.call(this,n,a):s.call(this,n,a));return this},n.removeEvent=function(e){var o,t=typeof e,n=this._getEvents();if("string"===t)delete n[e];else if("object"===t)for(o in n)n.hasOwnProperty(o)&&e.test(o)&&delete n[o];else delete this._events;return this},n.emitEvent=function(e,o){var t,n,a,r=this.getListenersAsObject(e);for(n in r)if(r.hasOwnProperty(n))for(t=r[n].length;t--;)a=o?r[n][t].apply(null,o):r[n][t](),a===!0&&this.removeListener(e,r[n][t]);return this},n.trigger=n.emitEvent,n.emit=function(e){var o=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,o)},"function"==typeof define&&define.amd?define(function(){return o}):e.EventEmitter=o}(this),window.w5capi_SIP=new EventEmitter,function($){"use strict";var escape=/["\\\x00-\x1f\x7f-\x9f]/g,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},hasOwn=Object.prototype.hasOwnProperty;$.toJSON="object"==typeof JSON&&JSON.stringify?JSON.stringify:function(e){if(null===e)return"null";var o,t,n,a,r=$.type(e);if("undefined"!==r){if("number"===r||"boolean"===r)return String(e);if("string"===r)return $.quoteString(e);if("function"==typeof e.toJSON)return $.toJSON(e.toJSON());if("date"===r){var s=e.getUTCMonth()+1,i=e.getUTCDate(),c=e.getUTCFullYear(),l=e.getUTCHours(),d=e.getUTCMinutes(),u=e.getUTCSeconds(),p=e.getUTCMilliseconds();return 10>s&&(s="0"+s),10>i&&(i="0"+i),10>l&&(l="0"+l),10>d&&(d="0"+d),10>u&&(u="0"+u),100>p&&(p="0"+p),10>p&&(p="0"+p),'"'+c+"-"+s+"-"+i+"T"+l+":"+d+":"+u+"."+p+'Z"'}if(o=[],$.isArray(e)){for(t=0;t<e.length;t++)o.push($.toJSON(e[t])||"null");return"["+o.join(",")+"]"}if("object"==typeof e){for(t in e)if(hasOwn.call(e,t)){if(r=typeof t,"number"===r)n='"'+t+'"';else{if("string"!==r)continue;n=$.quoteString(t)}r=typeof e[t],"function"!==r&&"undefined"!==r&&(a=$.toJSON(e[t]),o.push(n+":"+a))}return"{"+o.join(",")+"}"}}},$.evalJSON="object"==typeof JSON&&JSON.parse?JSON.parse:function(str){return eval("("+str+")")},$.secureEvalJSON="object"==typeof JSON&&JSON.parse?JSON.parse:function(str){var filtered=str.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"");if(/^[\],:{}\s]*$/.test(filtered))return eval("("+str+")");throw new SyntaxError("Error parsing JSON, source is not valid.")},$.quoteString=function(e){return e.match(escape)?'"'+e.replace(escape,function(e){var o=meta[e];return"string"==typeof o?o:(o=e.charCodeAt(),"\\u00"+Math.floor(o/16).toString(16)+(o%16).toString(16))})+'"':'"'+e+'"'}}(jQuery),function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e("object"==typeof exports?require("jquery"):jQuery)}(function(e){function o(e){return i.raw?e:encodeURIComponent(e)}function t(e){return i.raw?e:decodeURIComponent(e)}function n(e){return o(i.json?JSON.stringify(e):String(e))}function a(e){0===e.indexOf('"')&&(e=e.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,"\\"));try{return e=decodeURIComponent(e.replace(s," ")),i.json?JSON.parse(e):e}catch(o){}}function r(o,t){var n=i.raw?o:a(o);return e.isFunction(t)?t(n):n}var s=/\+/g,i=e.cookie=function(a,s,c){if(void 0!==s&&!e.isFunction(s)){if(c=e.extend({},i.defaults,c),"number"==typeof c.expires){var l=c.expires,d=c.expires=new Date;d.setTime(+d+864e5*l)}return document.cookie=[o(a),"=",n(s),c.expires?"; expires="+c.expires.toUTCString():"",c.path?"; path="+c.path:"",c.domain?"; domain="+c.domain:"",c.secure?"; secure":""].join("")}for(var u=a?void 0:{},p=document.cookie?document.cookie.split("; "):[],v=0,m=p.length;m>v;v++){var f=p[v].split("="),h=t(f.shift()),g=f.join("=");if(a&&a===h){u=r(g,s);break}a||void 0===(g=r(g))||(u[h]=g)}return u};i.defaults={},e.removeCookie=function(o,t){return void 0===e.cookie(o)?!1:(e.cookie(o,"",e.extend({},t,{expires:-1})),!e.cookie(o))}}),function(e){function o(e,o,n){return t(e,0,-1,o,n)}function t(e,o,t,n,a){for(var r=-1!=t?t:e.length,s=o;r>s;++s)if(0===e[s].indexOf(n)&&(!a||-1!==e[s].toLowerCase().indexOf(a.toLowerCase())))return s;return null}function n(e){var o=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),t=e.match(o);return t&&2==t.length?t[1]:null}function a(){e.FSRTC.moz=!!navigator.mozGetUserMedia,navigator.getUserMedia||(navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia)}function r(){return navigator.getUserMedia?!0:(alert("This application cannot function in this browser."),!1)}function s(e,o){console.log("There has been a problem retrieving the streams - did you allow access? Check Device Resolution",o),l(e,"onError",o)}function i(e,o){console.log("Stream Success"),l(e,"onStream",e.localStream)}function c(e,o){e.mediaData.candidate=o,e.mediaData.candidateList.push(e.mediaData.candidate),l(e,"onICE")}function l(e,o,t){o in e.options.callbacks&&e.options.callbacks[o](e,t)}function d(e,o){console.log("ICE Complete"),l(e,"onICEComplete")}function u(e,o){console.error("Channel Error",o),l(e,"onError",o)}function p(e,o){e.mediaData.SDP=e.stereoHack(o.sdp),console.log("ICE SDP"),l(e,"onICESDP")}function v(e,o){e.options.useVideo&&(e.options.useVideo.style.display="block");var t=e.options.useAudio;console.log("REMOTE STREAM",o,t),"undefined"!=typeof t.srcObject?t.srcObject=o:"undefined"!=typeof t.mozSrcObject?t.mozSrcObject=o:"undefined"!=typeof t.src?t.src=URL.createObjectURL(o):console.error("Error attaching stream to element."),e.options.useAudio.play(),e.remoteStream=o,l(e,"onRemoteStream",o)}function m(e,o){e.mediaData.SDP=e.stereoHack(o.sdp),console.log("Offer SDP"),l(e,"onOfferSDP")}function f(e){var o;e.options.useMic&&"none"===e.options.useMic?(console.log("Microphone Disabled"),o=!1):e.options.videoParams&&e.options.screenShare?(console.error("SCREEN SHARE"),o=!1):(o={mandatory:e.options.audioParams,optional:[]},"any"!==e.options.useMic&&(o.optional=[{sourceId:e.options.useMic}])),e.options.useVideo&&e.options.localVideo&&b({constraints:{audio:!1,video:{mandatory:e.options.videoParams,optional:[]}},localVideo:e.options.localVideo,onsuccess:function(e){self.options.localVideoStream=e,console.log("local video ready")},onerror:function(e){console.error("local video error!")}});var t={},n=e.options.videoParams.vertoBestFrameRate;delete e.options.videoParams.vertoBestFrameRate,window.moz?(t=e.options.videoParams,t.width||(t.width=t.minWidth),t.height||(t.height=t.minHeight),t.frameRate||(t.frameRate=t.minFrameRate)):t={mandatory:e.options.videoParams,optional:[]};var a=e.options.useVideo;return a&&e.options.useCamera&&"none"!==e.options.useCamera?(t.optional||(t.optional=[]),"any"!==e.options.useCamera&&t.optional.push({sourceId:e.options.useCamera}),n&&!window.moz&&t.optional.push({minFrameRate:n})):(console.log("Camera Disabled"),t=!1,a=!1),{audio:o,video:t,useVideo:a}}function g(e){function o(){v=!0,p=null,e.onICEComplete&&e.onICEComplete(),"offer"==e.type?(!moz||!e.sentICESDP&&_.localDescription.sdp.match(/a=candidate/)&&!w&&e.onICESDP)&&e.onICESDP(_.localDescription):!w&&e.onICESDP&&e.onICESDP(_.localDescription)}function t(){e.onOfferSDP&&_.createOffer(function(o){o.sdp=a(o.sdp),_.setLocalDescription(o),e.onOfferSDP(o),moz&&e.onICESDP&&o.sdp.match(/a=candidate/)&&(e.onICESDP(o),e.sentICESDP=1)},u,R)}function n(){"answer"==e.type&&(_.setRemoteDescription(new h(e.offerSDP),d,u),_.createAnswer(function(o){o.sdp=a(o.sdp),_.setLocalDescription(o),e.onAnswerSDP&&e.onAnswerSDP(o)},u,R))}function a(e){return e}function r(){!e.onChannelMessage||moz&&!e.onOfferSDP||(s(),moz&&navigator.mozGetUserMedia({audio:!0,fake:!0},function(e){_.addStream(e),t()},l))}function s(){E=_.createDataChannel(e.channel||"RTCDataChannel",moz?{}:{reliable:!1}),moz&&(E.binaryType="blob"),i()}function i(){E.onmessage=function(o){e.onChannelMessage&&e.onChannelMessage(o)},E.onopen=function(){e.onChannelOpened&&e.onChannelOpened(E)},E.onclose=function(o){e.onChannelClosed&&e.onChannelClosed(o),console.warn("WebRTC DataChannel closed",o)},E.onerror=function(o){e.onChannelError&&e.onChannelError(o),console.error("WebRTC DataChannel error",o)}}function c(){_.ondatachannel=function(e){E=e.channel,E.binaryType="blob",i()},moz&&navigator.mozGetUserMedia({audio:!0,fake:!0},function(e){_.addStream(e),n()},l)}function l(){log("Error in fake:true")}function d(){}function u(o){e.onChannelError&&e.onChannelError(o),console.error("sdp error:",o)}var p=!1,v=!1,m=window,f=m.mozRTCPeerConnection||m.webkitRTCPeerConnection,h=m.mozRTCSessionDescription||m.RTCSessionDescription,g=m.mozRTCIceCandidate||m.RTCIceCandidate,b={url:moz?"stun:23.21.150.121":"stun:stun.l.google.com:19302"},S=null;if(e.iceServers){var y=e.iceServers;"boolean"==typeof y&&(y=null),!y||"object"==typeof y&&y.constructor===Array||(console.warn("iceServers must be an array, reverting to default ice servers"),y=null),S={iceServers:y||[b]},moz||y||(S.iceServers=[b])}var C={optional:[]};moz||(C.optional=[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:e.onChannelMessage?!0:!1}]);var _=new f(S,C);r();var w=0;if(_.onicecandidate=function(t){v||(p||(p=setTimeout(o,1e3)),t?t.candidate&&e.onICE(t.candidate):(v=!0,p&&(clearTimeout(p),p=null),o()))},e.attachStream&&_.addStream(e.attachStream),e.attachStreams&&e.attachStream.length)for(var k=e.attachStreams,D=0;D<k.length;D++)_.addStream(k[D]);_.onaddstream=function(o){var t=o.stream;t.onended=function(){e.onRemoteStreamEnded&&e.onRemoteStreamEnded(t)},e.onRemoteStream&&e.onRemoteStream(t)};var R=e.constraints||{offerToReceiveAudio:!0,offerToReceiveVideo:!0};(e.onChannelMessage&&!moz||!e.onChannelMessage)&&(t(),n());var E;return e.onAnswerSDP&&moz&&e.onChannelMessage&&c(),{addAnswerSDP:function(e,o,t){_.setRemoteDescription(new h(e),o?o:d,t?t:u)},addICE:function(e){_.addIceCandidate(new g({sdpMLineIndex:e.sdpMLineIndex,candidate:e.candidate}))},peer:_,channel:E,sendData:function(e){E&&E.send(e)},stop:function(){_.close(),e.attachStream&&("function"==typeof e.attachStream.stop?e.attachStream.stop():e.attachStream.active=!1)}}}function b(e){function o(o){e.localVideo&&(e.localVideo[moz?"mozSrcObject":"src"]=moz?o:window.webkitURL.createObjectURL(o),e.localVideo.style.display="block"),e.onsuccess&&e.onsuccess(o),t=o}var t,n=navigator;return n.getMedia=n.webkitGetUserMedia||n.mozGetUserMedia,n.getMedia(e.constraints||{audio:!0,video:S},o,e.onerror||function(e){console.error(e)}),t}e.FSRTC=function(o){this.options=e.extend({useVideo:null,useStereo:!1,userData:null,localVideo:null,screenShare:!1,useCamera:"any",iceServers:!1,videoParams:{},audioParams:{},callbacks:{onICEComplete:function(){},onICE:function(){},onOfferSDP:function(){}}},o),this.audioEnabled=!0,this.videoEnabled=!0,this.mediaData={SDP:null,profile:{},candidateList:[]},moz?this.constraints={offerToReceiveAudio:!0,offerToReceiveVideo:this.options.useVideo?!0:!1}:this.constraints={optional:[{DtlsSrtpKeyAgreement:"true"}],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:this.options.useVideo?!0:!1}},self.options.useVideo,a(),r()},e.FSRTC.validRes=[],e.FSRTC.prototype.useVideo=function(e,o){var t=this;e?(t.options.useVideo=e,t.options.localVideo=o,moz?t.constraints.offerToReceiveVideo=!0:t.constraints.mandatory.OfferToReceiveVideo=!0):(t.options.useVideo=null,t.options.localVideo=null,moz?t.constraints.offerToReceiveVideo=!1:t.constraints.mandatory.OfferToReceiveVideo=!1),t.options.useVideo},e.FSRTC.prototype.useStereo=function(e){var o=this;o.options.useStereo=e},e.FSRTC.prototype.stereoHack=function(e){var t=this;if(!t.options.useStereo)return e;var a,r=e.split("\r\n"),s=o(r,"a=rtpmap","opus/48000");if(!s)return e;a=n(r[s]);var i=o(r,"a=fmtp:"+a.toString());return null===i?r[s]=r[s]+"\r\na=fmtp:"+a.toString()+" stereo=1; sprop-stereo=1":r[i]=r[i].concat("; stereo=1; sprop-stereo=1"),e=r.join("\r\n")},e.FSRTC.prototype.answer=function(e,o,t){this.peer.addAnswerSDP({type:"answer",sdp:e},o,t)},e.FSRTC.prototype.stopPeer=function(){self.peer&&(console.log("stopping peer"),self.peer.stop())},e.FSRTC.prototype.stop=function(){var e=this;if(e.localStream){if("function"==typeof e.localStream.stop)e.localStream.stop();else if(e.localStream.active){var o=e.localStream.getTracks();console.error(o),o.forEach(function(e,o){console.log(e),e.stop()})}e.localStream=null}if(e.options.localVideoStream)if("function"==typeof e.options.localVideoStream.stop)e.options.localVideoStream.stop();else if(e.localVideoStream.active){var o=e.localVideoStream.getTracks();console.error(o),o.forEach(function(e,o){console.log(e),e.stop()})}e.peer&&(console.log("stopping peer"),e.peer.stop())},e.FSRTC.prototype.getMute=function(){var e=this;return e.audioEnabled},e.FSRTC.prototype.setMute=function(e){for(var o=this,t=o.localStream.getAudioTracks(),n=0,a=t.length;a>n;n++){switch(e){case"on":t[n].enabled=!0;break;case"off":t[n].enabled=!1;break;case"toggle":t[n].enabled=!t[n].enabled}o.audioEnabled=t[n].enabled}return!o.audioEnabled},e.FSRTC.prototype.getVideoMute=function(){var e=this;return e.videoEnabled},e.FSRTC.prototype.setVideoMute=function(e){for(var o=this,t=o.localStream.getVideoTracks(),n=0,a=t.length;a>n;n++){switch(e){case"on":t[n].enabled=!0;break;case"off":t[n].enabled=!1;break;case"toggle":t[n].enabled=!t[n].enabled}o.videoEnabled=t[n].enabled}return!o.videoEnabled},e.FSRTC.prototype.createAnswer=function(e){function o(e){n.localStream=e,n.peer=g({type:n.type,attachStream:n.localStream,onICE:function(e){return c(n,e)},onICEComplete:function(){return d(n)},onRemoteStream:function(e){return v(n,e)},onICESDP:function(e){return p(n,e)},onChannelError:function(e){return u(n,e)},constraints:n.constraints,iceServers:n.options.iceServers,offerSDP:{type:"offer",sdp:n.remoteSDP}}),i(n)}function t(e){s(n,e)}var n=this;n.type="answer",n.remoteSDP=e.sdp,console.debug("inbound sdp: ",e.sdp);var a=f(n);console.log("Audio constraints",a.audio),console.log("Video constraints",a.video),n.options.useVideo&&n.options.localVideo&&b({constraints:{audio:!1,video:{mandatory:n.options.videoParams,optional:[]}},localVideo:n.options.localVideo,onsuccess:function(e){n.options.localVideoStream=e,console.log("local video ready")},onerror:function(e){console.error("local video error!")}}),b({constraints:{audio:a.audio,video:a.video},video:a.useVideo,onsuccess:o,onerror:t})},e.FSRTC.prototype.call=function(e){function o(e){n.localStream=e,a&&(moz?n.constraints.OfferToReceiveVideo=!1:n.constraints.mandatory.OfferToReceiveVideo=!1),n.peer=g({type:n.type,attachStream:n.localStream,onICE:function(e){return c(n,e)},onICEComplete:function(){return d(n)},onRemoteStream:a?function(e){}:function(e){return v(n,e)},onOfferSDP:function(e){return m(n,e)},onICESDP:function(e){return p(n,e)},onChannelError:function(e){return u(n,e)},constraints:n.constraints,iceServers:n.options.iceServers}),i(n,e)}function t(e){s(n,e)}r();var n=this,a=!1;n.type="offer",n.options.videoParams&&n.options.screenShare&&(a=!0);var l=f(n);console.log("Audio constraints",l.audio),console.log("Video constraints",l.video),l.audio||l.video?b({constraints:{audio:l.audio,video:l.video},video:l.useVideo,onsuccess:o,onerror:t}):o(null)},window.moz=!!navigator.mozGetUserMedia;var S={mandatory:{},optional:[]};e.FSRTC.resSupported=function(o,t){for(var n in e.FSRTC.validRes)if(e.FSRTC.validRes[n][0]==o&&e.FSRTC.validRes[n][1]==t)return!0;return!1},e.FSRTC.bestResSupported=function(){var o=0,t=0;for(var n in e.FSRTC.validRes)e.FSRTC.validRes[n][0]>o&&e.FSRTC.validRes[n][1]>t&&(o=e.FSRTC.validRes[n][0],t=e.FSRTC.validRes[n][1]);return[o,t]};var y=[[320,180],[320,240],[640,360],[640,480],[1280,720],[1920,1080]],C=0,_=0,k=function(o,t){if(C>=y.length){var n={validRes:e.FSRTC.validRes,bestResSupported:e.FSRTC.bestResSupported()};if(localStorage.setItem("res_"+o,e.toJSON(n)),t)return t(n)}else{var a={mandatory:{},optional:[]};o&&(a.optional=[{sourceId:o}]),w=y[C][0],h=y[C][1],C++,a.mandatory={minWidth:w,minHeight:h,maxWidth:w,maxHeight:h},window.moz&&(a=a.mandatory,a.width||(a.width=a.minWidth),a.height||(a.height=a.minHeight),a.frameRate||(a.frameRate=a.minFrameRate)),b({constraints:{audio:0==_++,video:a},onsuccess:function(n){n.getTracks().forEach(function(e){e.stop()}),console.info(w+"x"+h+" supported."),e.FSRTC.validRes.push([w,h]),k(o,t)},onerror:function(e){console.error(w+"x"+h+" not supported."),k(o,t)}})}};e.FSRTC.getValidRes=function(o,t){var n=localStorage.getItem("res_"+o);if(n){var a=e.parseJSON(n);return a?(e.FSRTC.validRes=a.validRes,console.log("CACHED RES FOR CAM "+o,a)):console.error("INVALID CACHE"),t?t(a):null}e.FSRTC.validRes=[],C=0,k(o,t)},e.FSRTC.checkPerms=function(o,t,n){b({constraints:{audio:t,video:n},onsuccess:function(e){e.getTracks().forEach(function(e){e.stop()}),console.info("media perm init complete"),o&&setTimeout(o,100,!0)},onerror:function(a){return n&&t?(console.error("error, retesting with audio params only"),e.FSRTC.checkPerms(o,t,!1)):(console.error("media perm init error"),void(o&&o(!1)))}})}}(jQuery),function(e){e.JsonRpcClient=function(o){var t=this;this.options=e.extend({ajaxUrl:null,socketUrl:null,onmessage:null,login:null,passwd:null,sessid:null,loginParams:null,userVariables:null,getSocket:function(e){return t._getSocket(e)}},o),t.ws_cnt=0,this.wsOnMessage=function(e){t._wsOnMessage(e)}},e.JsonRpcClient.prototype._ws_socket=null,e.JsonRpcClient.prototype._ws_callbacks={},e.JsonRpcClient.prototype._current_id=1,e.JsonRpcClient.prototype.speedTest=function(e,o){var t=this.options.getSocket(this.wsOnMessage);if(null!==t){this.speedCB=o,this.speedBytes=e,t.send("#SPU "+e);var n,a=e/1024,r=e%1024,s=new Array(1024).join(".");for(n=0;a>n;n++)t.send("#SPB "+s);r&&t.send("#SPB "+s),t.send("#SPE")}},e.JsonRpcClient.prototype.call=function(o,t,n,a){t||(t={}),this.options.sessid&&(t.sessid=this.options.sessid);var r={jsonrpc:"2.0",method:o,params:t,id:this._current_id++};n||(n=function(e){console.log("Success: ",e)}),a||(a=function(e){console.log("Error: ",e)});var s=this.options.getSocket(this.wsOnMessage);if(null!==s)return void this._wsCall(s,r,n,a);if(null===this.options.ajaxUrl)throw"$.JsonRpcClient.call used with no websocket and no http endpoint.";e.ajax({type:"POST",url:this.options.ajaxUrl,data:e.toJSON(r),dataType:"json",cache:!1,success:function(e){"error"in e&&a(e.error,this),n(e.result,this)},error:function(o,t,n){try{var r=e.parseJSON(o.responseText);"console"in window&&console.log(r),a(r.error,this)}catch(s){a({error:o.responseText},this)}}})},e.JsonRpcClient.prototype.notify=function(o,t){this.options.sessid&&(t.sessid=this.options.sessid);var n={jsonrpc:"2.0",method:o,params:t},a=this.options.getSocket(this.wsOnMessage);if(null!==a)return void this._wsCall(a,n);if(null===this.options.ajaxUrl)throw"$.JsonRpcClient.notify used with no websocket and no http endpoint.";e.ajax({type:"POST",url:this.options.ajaxUrl,data:e.toJSON(n),dataType:"json",cache:!1})},e.JsonRpcClient.prototype.batch=function(o,t,n){var a=new e.JsonRpcClient._batchObject(this,t,n);o(a),a._execute()},e.JsonRpcClient.prototype.socketReady=function(){return null===this._ws_socket||this._ws_socket.readyState>1?!1:!0},e.JsonRpcClient.prototype.closeSocket=function(){var e=this;e.socketReady()&&(e._ws_socket.onclose=function(e){console.log("Closing Socket")},e._ws_socket.close())},e.JsonRpcClient.prototype.loginData=function(e){var o=this;o.options.login=e.login,o.options.passwd=e.passwd,o.options.loginParams=e.loginParams,o.options.userVariables=e.userVariables},e.JsonRpcClient.prototype.connectSocket=function(o){var t=this;return t.to&&clearTimeout(t.to),t.socketReady()||(t.authing=!1,t._ws_socket&&delete t._ws_socket,t._ws_socket=new WebSocket(t.options.socketUrl),t._ws_socket&&(t._ws_socket.onmessage=o,t._ws_socket.onclose=function(e){t.ws_sleep||(t.ws_sleep=1e3),t.options.onWSClose&&t.options.onWSClose(t),console.error("Websocket Lost "+t.ws_cnt+" sleep: "+t.ws_sleep+"msec"),t.to=setTimeout(function(){console.log("Attempting Reconnection...."),t.connectSocket(o)},t.ws_sleep),t.ws_cnt++,t.ws_sleep<3e3&&t.ws_cnt%10===0&&(t.ws_sleep+=1e3)},t._ws_socket.onopen=function(){t.to&&clearTimeout(t.to),t.ws_sleep=1e3,t.ws_cnt=0,t.options.onWSConnect&&t.options.onWSConnect(t);for(var o;o=e.JsonRpcClient.q.pop();)t._ws_socket.send(o)})),t._ws_socket?!0:!1},e.JsonRpcClient.prototype._getSocket=function(e){return null!==this.options.socketUrl&&"WebSocket"in window?(this.connectSocket(e),this._ws_socket):null},e.JsonRpcClient.q=[],e.JsonRpcClient.prototype._wsCall=function(o,t,n,a){var r=e.toJSON(t);o.readyState<1?(self=this,e.JsonRpcClient.q.push(r)):o.send(r),"id"in t&&"undefined"!=typeof n&&(this._ws_callbacks[t.id]={request:r,request_obj:t,success_cb:n,error_cb:a})},e.JsonRpcClient.prototype._wsOnMessage=function(o){var t;if("#"!=o.data[0]||"S"!=o.data[1]||"P"!=o.data[2]){try{if(t=e.parseJSON(o.data),"object"==typeof t&&"jsonrpc"in t&&"2.0"===t.jsonrpc){if("result"in t&&this._ws_callbacks[t.id]){var n=this._ws_callbacks[t.id].success_cb;return delete this._ws_callbacks[t.id],void n(t.result,this)}if("error"in t&&this._ws_callbacks[t.id]){var a=this._ws_callbacks[t.id].error_cb,r=this._ws_callbacks[t.id].request;return!self.authing&&-32e3==t.error.code&&self.options.login&&self.options.passwd?(self.authing=!0,void this.call("login",{login:self.options.login,passwd:self.options.passwd,loginParams:self.options.loginParams,userVariables:self.options.userVariables},"login"==this._ws_callbacks[t.id].request_obj.method?function(e){self.authing=!1,console.log("logged in"),delete self._ws_callbacks[t.id],self.options.onWSLogin&&self.options.onWSLogin(!0,self)}:function(e){self.authing=!1,console.log("logged in, resending request id: "+t.id);var o=self.options.getSocket(self.wsOnMessage);null!==o&&o.send(r),self.options.onWSLogin&&self.options.onWSLogin(!0,self)},function(e){console.log("error logging in, request id:",t.id),delete self._ws_callbacks[t.id],a(t.error,this),self.options.onWSLogin&&self.options.onWSLogin(!1,self)})):(delete this._ws_callbacks[t.id],void a(t.error,this))}}}catch(s){return void console.log("ERROR: "+s)}if("function"==typeof this.options.onmessage){o.eventData=t,o.eventData||(o.eventData={});var i=this.options.onmessage(o);if(i&&"object"==typeof i&&o.eventData.id){var c={jsonrpc:"2.0",id:o.eventData.id,result:i},l=self.options.getSocket(self.wsOnMessage);null!==l&&l.send(e.toJSON(c))}}}else if("U"==o.data[3])this.up_dur=parseInt(o.data.substring(4));else if(this.speedCB&&"D"==o.data[3]){this.down_dur=parseInt(o.data.substring(4));var d=(8*this.speedBytes/(this.up_dur/1e3)/1024).toFixed(0),u=(8*this.speedBytes/(this.down_dur/1e3)/1024).toFixed(0);console.info("Speed Test: Up: "+d+" Down: "+u),this.speedCB(o,{upDur:this.up_dur,downDur:this.down_dur,upKPS:d,downKPS:u}),this.speedCB=null}},e.JsonRpcClient._batchObject=function(e,o,t){this._requests=[],this.jsonrpcclient=e,this.all_done_cb=o,this.error_cb="function"==typeof t?t:function(){}},e.JsonRpcClient._batchObject.prototype.call=function(e,o,t,n){o||(o={}),this.options.sessid&&(o.sessid=this.options.sessid),t||(t=function(e){console.log("Success: ",e)}),n||(n=function(e){console.log("Error: ",e)}),this._requests.push({request:{jsonrpc:"2.0",method:e,params:o,id:this.jsonrpcclient._current_id++},success_cb:t,error_cb:n})},e.JsonRpcClient._batchObject.prototype.notify=function(e,o){this.options.sessid&&(o.sessid=this.options.sessid),this._requests.push({request:{jsonrpc:"2.0",method:e,params:o}})},e.JsonRpcClient._batchObject.prototype._execute=function(){var o=this;if(0!==this._requests.length){var t,n,a,r=[],s={},i=0,c=o.jsonrpcclient.options.getSocket(o.jsonrpcclient.wsOnMessage);if(null!==c){for(i=0;i<this._requests.length;i++)t=this._requests[i],n="success_cb"in t?t.success_cb:void 0,a="error_cb"in t?t.error_cb:void 0,o.jsonrpcclient._wsCall(c,t.request,n,a);return void("function"==typeof all_done_cb&&all_done_cb(result))}for(i=0;i<this._requests.length;i++)t=this._requests[i],r.push(t.request),"id"in t.request&&(s[t.request.id]={success_cb:t.success_cb,error_cb:t.error_cb});if(n=function(e){o._batchCb(e,s,o.all_done_cb)},null===o.jsonrpcclient.options.ajaxUrl)throw"$.JsonRpcClient.batch used with no websocket and no http endpoint.";e.ajax({url:o.jsonrpcclient.options.ajaxUrl,data:e.toJSON(r),dataType:"json",cache:!1,type:"POST",error:function(e,t,n){o.error_cb(e,t,n)},success:n})}},e.JsonRpcClient._batchObject.prototype._batchCb=function(e,o,t){for(var n=0;n<e.length;n++){var a=e[n];"error"in a?null!==a.id&&a.id in o?o[a.id].error_cb(a.error,this):"console"in window&&console.log(a):!(a.id in o)&&"console"in window?console.log(a):o[a.id].success_cb(a.result,this)}"function"==typeof t&&t(e)}}(jQuery),function(e){function o(e,o){console.error("drop unauthorized channel: "+o),delete e.eventSUBS[o]}function t(e,o){for(var t in e.eventSUBS[o])e.eventSUBS[o][t].ready=!0,console.log("subscribed to channel: "+o),e.eventSUBS[o][t].readyHandler&&e.eventSUBS[o][t].readyHandler(e,o)}function n(e,o,t,n){var a=n||{},r=a.local,s={eventChannel:o,userData:a.userData,handler:a.handler,ready:!1,readyHandler:a.readyHandler,serno:c++},i=!1;return e.eventSUBS[o]||(e.eventSUBS[o]=[],t.push(o),i=!0),e.eventSUBS[o].push(s),r&&(s.ready=!0,s.local=!0),!i&&e.eventSUBS[o][0].ready&&(s.ready=!0,s.readyHandler&&s.readyHandler(e,o)),{serno:s.serno,eventChannel:o}}function a(){e.verto.conf.prototype.listVideoLayouts=function(){this.modCommand("list-videoLayouts",null,null)},e.verto.conf.prototype.play=function(e){this.modCommand("play",null,e)},e.verto.conf.prototype.stop=function(){this.modCommand("stop",null,"all")},e.verto.conf.prototype.record=function(e){this.modCommand("recording",null,["start",e])},e.verto.conf.prototype.stopRecord=function(){this.modCommand("recording",null,["stop","all"])},e.verto.conf.prototype.snapshot=function(e){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("vid-write-png",null,e)},e.verto.conf.prototype.setVideoLayout=function(e){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("vid-layout",null,e)},e.verto.conf.prototype.kick=function(e){this.modCommand("kick",parseInt(e))},e.verto.conf.prototype.muteMic=function(e){this.modCommand("tmute",parseInt(e))},e.verto.conf.prototype.muteVideo=function(e){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("tvmute",parseInt(e))},e.verto.conf.prototype.presenter=function(e){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("vid-res-id",parseInt(e),"presenter")},e.verto.conf.prototype.videoFloor=function(e){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("vid-floor",parseInt(e),"force")},e.verto.conf.prototype.banner=function(e,o){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("vid-banner",parseInt(e),escape(o))},e.verto.conf.prototype.volumeDown=function(e){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("volume_in",parseInt(e),"down")},e.verto.conf.prototype.volumeUp=function(e){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("volume_in",parseInt(e),"up")},e.verto.conf.prototype.transfer=function(e,o){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("transfer",parseInt(e),o)},e.verto.conf.prototype.sendChat=function(e,o){var t=this;t.verto.rpcClient.call("verto.broadcast",{eventChannel:t.params.laData.chatChannel,data:{action:"send",message:e,type:o}})}}function r(o,t){return t==e.verto["enum"].state.purge||e.verto["enum"].states[o.name][t.name]?!0:!1}function s(o){for(var t in e.verto.audioOutDevices){var n=e.verto.audioOutDevices[t];if(n.id===o)return n.label}return o}var i="undefined"!=typeof window.crypto&&"undefined"!=typeof window.crypto.getRandomValues?function(){var e=new Uint16Array(8);window.crypto.getRandomValues(e);var o=function(e){for(var o=e.toString(16);o.length<4;)o="0"+o;return o};return o(e[0])+o(e[1])+"-"+o(e[2])+"-"+o(e[3])+"-"+o(e[4])+"-"+o(e[5])+o(e[6])+o(e[7])}:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var o=16*Math.random()|0,t="x"==e?o:3&o|8;return t.toString(16)})};e.verto=function(o,t){var n=this;e.verto.saved.push(n),n.options=e.extend({login:null,passwd:null,socketUrl:null,tag:null,localTag:null,videoParams:{},audioParams:{},loginParams:{},deviceParams:{onResCheck:null},userVariables:{},iceServers:!1,ringSleep:6e3,sessid:null},o),n.options.deviceParams.useCamera&&e.FSRTC.getValidRes(n.options.deviceParams.useCamera,n.options.deviceParams.onResCheck),n.options.deviceParams.useMic||(n.options.deviceParams.useMic="any"),n.options.deviceParams.useSpeak||(n.options.deviceParams.useSpeak="any"),n.options.sessid?n.sessid=n.options.sessid:(n.sessid=localStorage.getItem("verto_session_uuid")||i(),localStorage.setItem("verto_session_uuid",n.sessid)),n.dialogs={},n.callbacks=t||{},n.eventSUBS={},n.rpcClient=new e.JsonRpcClient({login:n.options.login,passwd:n.options.passwd,socketUrl:n.options.socketUrl,loginParams:n.options.loginParams,userVariables:n.options.userVariables,sessid:n.sessid,onmessage:function(e){return n.handleMessage(e.eventData)},onWSConnect:function(e){e.call("login",{})},onWSLogin:function(e){n.callbacks.onWSLogin&&n.callbacks.onWSLogin(n,e)},onWSClose:function(e){n.callbacks.onWSClose&&n.callbacks.onWSClose(n,e),n.purge()}}),n.options.ringFile&&n.options.tag&&(n.ringer=e("#"+n.options.tag)),n.rpcClient.call("login",{})},e.verto.prototype.deviceParams=function(o){var t=this;for(var n in o)t.options.deviceParams[n]=o[n];o.useCamera&&e.FSRTC.getValidRes(t.options.deviceParams.useCamera,o?o.onResCheck:void 0)},e.verto.prototype.videoParams=function(e){var o=this;for(var t in e)o.options.videoParams[t]=e[t]},e.verto.prototype.iceServers=function(e){var o=this;o.options.iceServers=e},e.verto.prototype.loginData=function(e){var o=this;o.options.login=e.login,o.options.passwd=e.passwd,o.rpcClient.loginData(e)},e.verto.prototype.logout=function(e){var o=this;o.rpcClient.closeSocket(),o.callbacks.onWSClose&&o.callbacks.onWSClose(o,!1),o.purge()},e.verto.prototype.login=function(e){var o=this;o.logout(),o.rpcClient.call("login",{})},e.verto.prototype.message=function(e){var o=this,t=0;return e.to||(console.error("Missing To"),t++),e.body||(console.error("Missing Body"),t++),t?!1:(o.sendMethod("verto.info",{msg:e}),!0)},e.verto.prototype.processReply=function(e,n,a){var r,s=this;switch(e){case"verto.subscribe":for(r in a.unauthorizedChannels)o(s,a.unauthorizedChannels[r]);for(r in a.subscribedChannels)t(s,a.subscribedChannels[r]);break;case"verto.unsubscribe":}},e.verto.prototype.sendMethod=function(e,o){var t=this;t.rpcClient.call(e,o,function(o){t.processReply(e,!0,o)},function(o){t.processReply(e,!1,o)})};var c=1;e.verto.prototype.subscribe=function(e,o){
var t=this,a=[],r=[],s=o||{};if("string"==typeof e)a.push(n(t,e,r,s));else for(var i in e)a.push(n(t,e,r,s));return r.length&&t.sendMethod("verto.subscribe",{eventChannel:1==r.length?r[0]:r,subParams:s.subParams}),a},e.verto.prototype.unsubscribe=function(e){var o,t=this;if(e){var n,a={},r=[];if("string"==typeof e)delete t.eventSUBS[e],a[e]++;else for(o in e)if("string"==typeof e[o])n=e[o],delete t.eventSUBS[n],a[n]++;else{var s=[];n=e[o].eventChannel;for(var i in t.eventSUBS[n])t.eventSUBS[n][i].serno==e[o].serno||s.push(t.eventSUBS[n][i]);t.eventSUBS[n]=s,0===t.eventSUBS[n].length&&(delete t.eventSUBS[n],a[n]++)}for(var c in a)console.log("Sending Unsubscribe for: ",c),r.push(c);r.length&&t.sendMethod("verto.unsubscribe",{eventChannel:1==r.length?r[0]:r})}else for(o in t.eventSUBS)t.eventSUBS[o]&&t.unsubscribe(t.eventSUBS[o])},e.verto.prototype.broadcast=function(e,o){var t=this,n={eventChannel:e,data:{}};for(var a in o)n.data[a]=o[a];t.sendMethod("verto.broadcast",n)},e.verto.prototype.purge=function(o){var t,n=this,a=0;for(t in n.dialogs)a||console.log("purging dialogs"),a++,n.dialogs[t].setState(e.verto["enum"].state.purge);for(t in n.eventSUBS)n.eventSUBS[t]&&(console.log("purging subscription: "+t),delete n.eventSUBS[t])},e.verto.prototype.hangup=function(e){var o=this;if(e){var t=o.dialogs[e];t&&t.hangup()}else for(var n in o.dialogs)o.dialogs[n].hangup()},e.verto.prototype.newCall=function(o,t){var n=this;if(!n.rpcClient.socketReady())return void console.error("Not Connected...");var a=new e.verto.dialog(e.verto["enum"].direction.outbound,this,o);return a.invite(),t&&(a.callbacks=t),a},e.verto.prototype.handleMessage=function(o){var t=this;if(!o||!o.method)return void console.error("Invalid Data",o);if(o.params.callID){var n=t.dialogs[o.params.callID];if("verto.attach"===o.method&&n&&(delete n.verto.dialogs[n.callID],n.rtc.stop(),n=null),n)switch(o.method){case"verto.bye":n.hangup(o.params);break;case"verto.answer":n.handleAnswer(o.params);break;case"verto.media":n.handleMedia(o.params);break;case"verto.display":n.handleDisplay(o.params);break;case"verto.info":n.handleInfo(o.params);break;default:console.debug("INVALID METHOD OR NON-EXISTANT CALL REFERENCE IGNORED",n,o.method)}else switch(o.method){case"verto.attach":o.params.attach=!0,o.params.sdp&&o.params.sdp.indexOf("m=video")>0&&(o.params.useVideo=!0),o.params.sdp&&o.params.sdp.indexOf("stereo=1")>0&&(o.params.useStereo=!0),n=new e.verto.dialog(e.verto["enum"].direction.inbound,t,o.params),n.setState(e.verto["enum"].state.recovering);break;case"verto.invite":o.params.sdp&&o.params.sdp.indexOf("m=video")>0&&(o.params.wantVideo=!0),o.params.sdp&&o.params.sdp.indexOf("stereo=1")>0&&(o.params.useStereo=!0),n=new e.verto.dialog(e.verto["enum"].direction.inbound,t,o.params);break;default:console.debug("INVALID METHOD OR NON-EXISTANT CALL REFERENCE IGNORED")}return{method:o.method}}switch(o.method){case"verto.punt":t.purge(),t.logout();break;case"verto.event":var a=null,r=null;if(o.params&&(r=o.params.eventChannel),r&&(a=t.eventSUBS[r],a||(a=t.eventSUBS[r.split(".")[0]])),!a&&r&&r===t.sessid)t.callbacks.onMessage&&t.callbacks.onMessage(t,null,e.verto["enum"].message.pvtEvent,o.params);else if(!a&&r&&t.dialogs[r])t.dialogs[r].sendMessage(e.verto["enum"].message.pvtEvent,o.params);else if(a)for(var s in a){var i=a[s];i&&i.ready?i.handler?i.handler(t,o.params,i.userData):t.callbacks.onEvent?t.callbacks.onEvent(t,o.params,i.userData):console.log("EVENT:",o.params):console.error("invalid EVENT for "+r+" IGNORED")}else r||(r="UNDEFINED"),console.error("UNSUBBED or invalid EVENT "+r+" IGNORED");break;case"verto.info":t.callbacks.onMessage&&t.callbacks.onMessage(t,null,e.verto["enum"].message.info,o.params.msg),console.debug("MESSAGE from: "+o.params.msg.from,o.params.msg.body);break;default:console.error("INVALID METHOD OR NON-EXISTANT CALL REFERENCE IGNORED",o.method)}};var l=function(e,o){for(var t=[],n=e.length,a=0;n>a;a++)e[a]!=o&&t.push(e[a]);return t},d=function(){var e=this,o={},t=[];e.reorder=function(e){t=e;var n=o;o={};for(var a=t.length,r=0;a>r;r++){var s=t[r];n[s]&&(o[s]=n[s],delete n[s])}n=void 0},e.clear=function(){o=void 0,t=void 0,o={},t=[]},e.add=function(e,n,a){var r=!1;if(!o[e])if(void 0===a||0>a||a>=t.length)t.push(e);else{for(var s=0,i=[],c=t.length,l=0;c>l;l++)s++==a&&i.push(e),i.push(t[l]);t=void 0,t=i,i=void 0,r=!0}return o[e]=n,r},e.del=function(e){var n=!1;return o[e]?(t=l(t,e),delete o[e],n=!0):console.error("can't del nonexistant key "+e),n},e.get=function(e){return o[e]},e.order=function(){return t},e.hash=function(){return o},e.indexOf=function(e){for(var o=t.length,n=0;o>n;n++)if(t[n]==e)return n},e.arrayLen=function(){return t.length},e.asArray=function(){for(var e=[],n=t.length,a=0;n>a;a++){var r=t[a];e.push(o[r])}return e},e.each=function(e){for(var n=t.length,a=0;n>a;a++)e(t[a],o[t[a]])},e.dump=function(o){var t="";return e.each(function(e,n){t+="name: "+e+" val: "+JSON.stringify(n)+(o?"<br>":"\n")}),t}};e.verto.liveArray=function(e,o,t,n){var a=this,r=0,s=null,i=n.userObj;d.call(a),a._add=a.add,a._del=a.del,a._reorder=a.reorder,a._clear=a.clear,a.context=o,a.name=t,a.user_obj=i,a.verto=e,a.broadcast=function(o,t){e.broadcast(o,t)},a.errs=0,a.clear=function(){a._clear(),r=0,a.onChange&&a.onChange(a,{action:"clear"})},a.checkSerno=function(e){return 0>e?!0:r>0&&e!=r+1?(a.onErr&&a.onErr(a,{lastSerno:r,serno:e}),a.errs++,console.debug(a.errs),a.errs<3&&a.bootstrap(a.user_obj),!1):(r=e,!0)},a.reorder=function(e,o){a.checkSerno(e)&&(a._reorder(o),a.onChange&&a.onChange(a,{serno:e,action:"reorder"}))},a.init=function(e,o,t,n){(null===t||void 0===t)&&(t=e),a.checkSerno(e)&&a.onChange&&a.onChange(a,{serno:e,action:"init",index:n,key:t,data:o})},a.bootObj=function(e,o){if(a.checkSerno(e)){for(var t in o)a._add(o[t][0],o[t][1]);a.onChange&&a.onChange(a,{serno:e,action:"bootObj",data:o,redraw:!0})}},a.add=function(e,o,t,n){if((null===t||void 0===t)&&(t=e),a.checkSerno(e)){var r=a._add(t,o,n);a.onChange&&a.onChange(a,{serno:e,action:"add",index:n,key:t,data:o,redraw:r})}},a.modify=function(e,o,t,n){(null===t||void 0===t)&&(t=e),a.checkSerno(e)&&(a._add(t,o,n),a.onChange&&a.onChange(a,{serno:e,action:"modify",key:t,data:o,index:n}))},a.del=function(e,o,t){if((null===o||void 0===o)&&(o=e),a.checkSerno(e)){(null===t||0>t||void 0===t)&&(t=a.indexOf(o));var n=a._del(o);n&&a.onChange&&a.onChange(a,{serno:e,action:"del",key:o,index:t})}};var c=function(e,o,t){var n=o.data;if(n.name==t.name)switch(n.action){case"init":t.init(n.wireSerno,n.data,n.hashKey,n.arrIndex);break;case"bootObj":t.bootObj(n.wireSerno,n.data);break;case"add":t.add(n.wireSerno,n.data,n.hashKey,n.arrIndex);break;case"modify":n.arrIndex||n.hashKey?t.modify(n.wireSerno,n.data,n.hashKey,n.arrIndex):console.error("Invalid Packet",n);break;case"del":n.arrIndex||n.hashKey?t.del(n.wireSerno,n.hashKey,n.arrIndex):console.error("Invalid Packet",n);break;case"clear":t.clear();break;case"reorder":t.reorder(n.wireSerno,n.order);break;default:t.checkSerno(n.wireSerno)&&t.onChange&&t.onChange(t,{serno:n.wireSerno,action:n.action,data:n.data})}};a.context&&(s=a.verto.subscribe(a.context,{handler:c,userData:a,subParams:n.subParams})),a.destroy=function(){a._clear(),a.verto.unsubscribe(s)},a.sendCommand=function(e,o){var t=a;t.broadcast(t.context,{liveArray:{command:e,context:t.context,name:t.name,obj:o}})},a.bootstrap=function(e){a.sendCommand("bootstrap",e)},a.changepage=function(e){var o=a;o.clear(),o.broadcast(o.context,{liveArray:{command:"changepage",context:a.context,name:a.name,obj:e}})},a.heartbeat=function(e){var o=a,t=function(){o.heartbeat.call(o,e)};o.broadcast(o.context,{liveArray:{command:"heartbeat",context:o.context,name:o.name,obj:e}}),o.hb_pid=setTimeout(t,3e4)},a.bootstrap(a.user_obj)},e.verto.liveTable=function(o,t,n,a,r){function s(o){if("string"==typeof o[4]&&o[4].indexOf("{")>-1){var t=e.parseJSON(o[4]);o[4]=t.oldStatus,o[5]=null}return o}function i(e){var o=e.asArray();for(var t in o)o[t]=s(o[t]);return o}var c,l=new e.verto.liveArray(o,t,n,{subParams:r.subParams}),d=this;d.liveArray=l,d.dataTable=c,d.verto=o,d.destroy=function(){c&&c.fnDestroy(),l&&l.destroy(),c=null,l=null},l.onErr=function(e,o){console.error("Error: ",e,o)},l.onChange=function(e,o){var t=0,n=0;if(!c){if(!r.aoColumns){if("init"!=o.action)return;r.aoColumns=[];for(var d in o.data)r.aoColumns.push({sTitle:o.data[d]})}c=a.dataTable(r)}if(c&&("del"==o.action||"modify"==o.action)&&(t=o.index,void 0===t&&o.key&&(t=l.indexOf(o.key)),void 0===t))return void console.error("INVALID PACKET Missing INDEX\n",o);r.onChange&&r.onChange(e,o);try{switch(o.action){case"bootObj":if(!o.data)return void console.error("missing data");c.fnClearTable(),c.fnAddData(i(e)),c.fnAdjustColumnSizing();break;case"add":if(!o.data)return void console.error("missing data");o.redraw>-1?(c.fnClearTable(),c.fnAddData(i(e))):c.fnAddData(s(o.data)),c.fnAdjustColumnSizing();break;case"modify":if(!o.data)return;c.fnUpdate(s(o.data),t),c.fnAdjustColumnSizing();break;case"del":c.fnDeleteRow(t),c.fnAdjustColumnSizing();break;case"clear":c.fnClearTable();break;case"reorder":c.fnClearTable(),c.fnAddData(i(e));break;case"hide":a.hide();break;case"show":a.show()}}catch(u){console.error("ERROR: "+u),n++}n?(e.errs++,e.errs<3&&e.bootstrap(e.user_obj)):e.errs=0},l.onChange(l,{action:"init"})};var u=1;e.verto.conf=function(o,t){var n=this;n.params=e.extend({dialog:null,hasVid:!1,laData:null,onBroadcast:null,onLaChange:null,onLaRow:null},t),n.verto=o,n.serno=u++,a(),o.subscribe(n.params.laData.modChannel,{handler:function(e,t){n.params.onBroadcast&&n.params.onBroadcast(o,n,t.data)}}),o.subscribe(n.params.laData.chatChannel,{handler:function(e,o){"function"==typeof n.params.chatCallback&&n.params.chatCallback(e,o)}})},e.verto.conf.prototype.modCommand=function(e,o,t){var n=this;n.verto.rpcClient.call("verto.broadcast",{eventChannel:n.params.laData.modChannel,data:{application:"conf-control",command:e,id:o,value:t}})},e.verto.conf.prototype.destroy=function(){var e=this;e.destroyed=!0,e.params.onBroadcast(e.verto,e,"destroy"),e.params.laData.modChannel&&e.verto.unsubscribe(e.params.laData.modChannel),e.params.laData.chatChannel&&e.verto.unsubscribe(e.params.laData.chatChannel)},e.verto.modfuncs={},e.verto.confMan=function(o,t){function n(o){var t="play_"+r.serno,n="stop_"+r.serno,a="recording_"+r.serno,s="snapshot_"+r.serno,i="recording_stop"+r.serno,c="confman_"+r.serno,l="<div id='"+c+"'><br><button class='ctlbtn' id='"+t+"'>Play</button><button class='ctlbtn' id='"+n+"'>Stop</button><button class='ctlbtn' id='"+a+"'>Record</button><button class='ctlbtn' id='"+i+"'>Record Stop</button>"+(r.params.hasVid?"<button class='ctlbtn' id='"+s+"'>PNG Snapshot</button>":"")+"<br><br></div>";if(o.html(l),e.verto.modfuncs.change_video_layout=function(o,t){var n=e("#"+o+" option:selected").text();"none"!==n&&r.modCommand("vid-layout",null,[n,t])},r.params.hasVid){for(var d=0;d<r.canvasCount;d++){var u="confman_vid_layout_"+d+"_"+r.serno,p="confman_vl_select_"+d+"_"+r.serno,v="<div id='"+u+"'><br><b>Video Layout Canvas "+(d+1)+"</b> <select onChange='$.verto.modfuncs.change_video_layout(\""+u+'", "'+d+"\")' id='"+p+"'></select> <br><br></div>";o.append(v)}e("#"+s).click(function(){var e=prompt("Please enter file name","");e&&r.modCommand("vid-write-png",null,e)})}e("#"+t).click(function(){var e=prompt("Please enter file name","");e&&r.modCommand("play",null,e)}),e("#"+n).click(function(){r.modCommand("stop",null,"all")}),e("#"+a).click(function(){var e=prompt("Please enter file name","");e&&r.modCommand("recording",null,["start",e])}),e("#"+i).click(function(){r.modCommand("recording",null,["stop","all"])})}function a(o,t){var n=parseInt(t),a="kick_"+n,s="canvas_in_next_"+n,i="canvas_in_prev_"+n,c="canvas_out_next_"+n,l="canvas_out_prev_"+n,d="canvas_in_set_"+n,u="canvas_out_set_"+n,p="layer_set_"+n,v="layer_next_"+n,m="layer_prev_"+n,f="tmute_"+n,h="tvmute_"+n,g="vbanner_"+n,b="tvpresenter_"+n,S="tvfloor_"+n,y="box_"+n,C="volume_in_up"+n,_="volume_in_dn"+n,w="transfer"+n,k="<div id='"+y+"'>";return k+="<b>General Controls</b><hr noshade>",k+="<button class='ctlbtn' id='"+a+"'>Kick</button><button class='ctlbtn' id='"+f+"'>Mute</button><button class='ctlbtn' id='"+_+"'>Vol -</button><button class='ctlbtn' id='"+C+"'>Vol +</button><button class='ctlbtn' id='"+w+"'>Transfer</button>",r.params.hasVid&&(k+="<br><br><b>Video Controls</b><hr noshade>",k+="<button class='ctlbtn' id='"+h+"'>VMute</button><button class='ctlbtn' id='"+b+"'>Presenter</button><button class='ctlbtn' id='"+S+"'>Vid Floor</button><button class='ctlbtn' id='"+g+"'>Banner</button>",r.canvasCount>1&&(k+="<br><br><b>Canvas Controls</b><hr noshade><button class='ctlbtn' id='"+d+"'>Set Input Canvas</button><button class='ctlbtn' id='"+i+"'>Prev Input Canvas</button><button class='ctlbtn' id='"+s+"'>Next Input Canvas</button><br><button class='ctlbtn' id='"+u+"'>Set Watching Canvas</button><button class='ctlbtn' id='"+l+"'>Prev Watching Canvas</button><button class='ctlbtn' id='"+c+"'>Next Watching Canvas</button>"),k+="<br><button class='ctlbtn' id='"+p+"'>Set Layer</button><button class='ctlbtn' id='"+m+"'>Prev Layer</button><button class='ctlbtn' id='"+v+"'>Next Layer</button></div>"),o.html(k),o.data("mouse")||e("#"+y).hide(),o.mouseover(function(t){o.data({mouse:!0}),e("#"+y).show()}),o.mouseout(function(t){o.data({mouse:!1}),e("#"+y).hide()}),e("#"+w).click(function(){var e=prompt("Enter Extension");e&&r.modCommand("transfer",n,e)}),e("#"+a).click(function(){r.modCommand("kick",n)}),e("#"+p).click(function(){var e=prompt("Please enter layer ID","");e&&r.modCommand("vid-layer",n,e)}),e("#"+v).click(function(){r.modCommand("vid-layer",n,"next")}),e("#"+m).click(function(){r.modCommand("vid-layer",n,"prev")}),e("#"+d).click(function(){var e=prompt("Please enter canvas ID","");e&&r.modCommand("vid-canvas",n,e)}),e("#"+u).click(function(){var e=prompt("Please enter canvas ID","");e&&r.modCommand("vid-watching-canvas",n,e)}),e("#"+s).click(function(){r.modCommand("vid-canvas",n,"next")}),e("#"+i).click(function(){r.modCommand("vid-canvas",n,"prev")}),e("#"+c).click(function(){r.modCommand("vid-watching-canvas",n,"next")}),e("#"+l).click(function(){r.modCommand("vid-watching-canvas",n,"prev")}),e("#"+f).click(function(){r.modCommand("tmute",n)}),r.params.hasVid&&(e("#"+h).click(function(){r.modCommand("tvmute",n)}),e("#"+b).click(function(){r.modCommand("vid-res-id",n,"presenter")}),e("#"+S).click(function(){r.modCommand("vid-floor",n,"force")}),e("#"+g).click(function(){var e=prompt("Please enter text","");e&&r.modCommand("vid-banner",n,escape(e))})),e("#"+C).click(function(){r.modCommand("volume_in",n,"up")}),e("#"+_).click(function(){r.modCommand("volume_in",n,"down")}),k}var r=this;r.params=e.extend({tableID:null,statusID:null,mainModID:null,dialog:null,hasVid:!1,laData:null,onBroadcast:null,onLaChange:null,onLaRow:null},t),r.verto=o,r.serno=u++,r.canvasCount=r.params.laData.canvasCount;var s="",i=0;o.subscribe(r.params.laData.chatChannel,{handler:function(e,o){"function"==typeof r.params.chatCallback&&r.params.chatCallback(e,o)}}),"moderator"===r.params.laData.role&&(s="Action",i=600,r.params.mainModID?(n(e(r.params.mainModID)),e(r.params.displayID).html("Moderator Controls Ready<br><br>")):e(r.params.mainModID).html(""),o.subscribe(r.params.laData.modChannel,{handler:function(t,n){if(r.params.onBroadcast&&r.params.onBroadcast(o,r,n.data),"list-videoLayouts"===n.data["conf-command"])for(var a=0;a<r.canvasCount;a++){var s,i="#confman_vl_select_"+a+"_"+r.serno,c="#confman_vid_layout_"+a+"_"+r.serno,l=0;if(e(i).selectmenu({}),e(i).selectmenu("enable"),e(i).empty(),e(i).append(new Option("Choose a Layout","none")),n.data.responseData){s=n.data.responseData.sort();for(var d in s)e(i).append(new Option(s[d],s[d])),l++}l?e(i).selectmenu("refresh",!0):e(c).hide()}else!r.destroyed&&r.params.displayID&&(e(r.params.displayID).html(n.data.response+"<br><br>"),r.lastTimeout&&(clearTimeout(r.lastTimeout),r.lastTimeout=0),r.lastTimeout=setTimeout(function(){e(r.params.displayID).html(r.destroyed?"":"Moderator Controls Ready<br><br>")},4e3))}}),r.params.hasVid&&r.modCommand("list-videoLayouts",null,null));var c=null;"moderator"===r.params.laData.role&&(c=function(t,n,s,i){if(!n[5]){var c=e("td:eq(5)",t);a(c,n),r.params.onLaRow&&r.params.onLaRow(o,r,c,n)}}),r.lt=new e.verto.liveTable(o,r.params.laData.laChannel,r.params.laData.laName,e(r.params.tableID),{subParams:{callID:r.params.dialog?r.params.dialog.callID:null},onChange:function(t,n){e(r.params.statusID).text("Conference Members:  ("+t.arrayLen()+" Total)"),r.params.onLaChange&&r.params.onLaChange(o,r,e.verto["enum"].confEvent.laChange,t,n)},aaData:[],aoColumns:[{sTitle:"ID",sWidth:"50"},{sTitle:"Number",sWidth:"250"},{sTitle:"Name",sWidth:"250"},{sTitle:"Codec",sWidth:"100"},{sTitle:"Status",sWidth:r.params.hasVid?"200px":"150px"},{sTitle:s,sWidth:i}],bAutoWidth:!0,bDestroy:!0,bSort:!1,bInfo:!1,bFilter:!1,bLengthChange:!1,bPaginate:!1,iDisplayLength:1400,oLanguage:{sEmptyTable:"The Conference is Empty....."},fnRowCallback:c})},e.verto.confMan.prototype.modCommand=function(e,o,t){var n=this;n.verto.rpcClient.call("verto.broadcast",{eventChannel:n.params.laData.modChannel,data:{application:"conf-control",command:e,id:o,value:t}})},e.verto.confMan.prototype.sendChat=function(e,o){var t=this;t.verto.rpcClient.call("verto.broadcast",{eventChannel:t.params.laData.chatChannel,data:{action:"send",message:e,type:o}})},e.verto.confMan.prototype.destroy=function(){var o=this;o.destroyed=!0,o.lt&&o.lt.destroy(),o.params.laData.chatChannel&&o.verto.unsubscribe(o.params.laData.chatChannel),o.params.laData.modChannel&&o.verto.unsubscribe(o.params.laData.modChannel),o.params.mainModID&&e(o.params.mainModID).html("")},e.verto.dialog=function(o,t,n){var a=this;a.params=e.extend({useVideo:t.options.useVideo,useStereo:t.options.useStereo,screenShare:!1,useCamera:t.options.deviceParams.useCamera,useMic:t.options.deviceParams.useMic,useSpeak:t.options.deviceParams.useSpeak,tag:t.options.tag,localTag:t.options.localTag,login:t.options.login,videoParams:t.options.videoParams},n),a.verto=t,a.direction=o,a.lastState=null,a.state=a.lastState=e.verto["enum"].state["new"],a.callbacks=t.callbacks,a.answered=!1,a.attach=n.attach||!1,a.screenShare=n.screenShare||!1,a.useCamera=a.params.useCamera,a.useMic=a.params.useMic,a.useSpeak=a.params.useSpeak,a.params.callID?a.callID=a.params.callID:a.callID=a.params.callID=i(),a.params.tag&&(a.audioStream=document.getElementById(a.params.tag),a.params.useVideo&&(a.videoStream=a.audioStream)),a.params.localTag&&(a.localVideo=document.getElementById(a.params.localTag)),a.verto.dialogs[a.callID]=a;var r={};a.direction==e.verto["enum"].direction.inbound?("outbound"===a.params.display_direction?(a.params.remote_caller_id_name=a.params.caller_id_name,a.params.remote_caller_id_number=a.params.caller_id_number):(a.params.remote_caller_id_name=a.params.callee_id_name,a.params.remote_caller_id_number=a.params.callee_id_number),a.params.remote_caller_id_name||(a.params.remote_caller_id_name="Nobody"),a.params.remote_caller_id_number||(a.params.remote_caller_id_number="UNKNOWN"),r.onMessage=function(e,o){console.debug(o)},r.onAnswerSDP=function(e,o){console.error("answer sdp",o)}):(a.params.remote_caller_id_name="Outbound Call",a.params.remote_caller_id_number=a.params.destination_number),r.onICESDP=function(o){return console.log("RECV "+o.type+" SDP",o.mediaData.SDP),a.state==e.verto["enum"].state.requesting||a.state==e.verto["enum"].state.answering||a.state==e.verto["enum"].state.active?void location.reload():void("offer"==o.type?a.state==e.verto["enum"].state.active?(a.setState(e.verto["enum"].state.requesting),a.sendMethod("verto.attach",{sdp:o.mediaData.SDP})):(a.setState(e.verto["enum"].state.requesting),a.sendMethod("verto.invite",{sdp:o.mediaData.SDP})):(a.setState(e.verto["enum"].state.answering),a.sendMethod(a.attach?"verto.attach":"verto.answer",{sdp:a.rtc.mediaData.SDP})))},r.onICE=function(e){return"offer"==e.type?void console.log("offer",e.mediaData.candidate):void 0},r.onStream=function(e,o){console.log("stream started"),window.w5capi_SIP.emit("SIP-localstream",{stream:o})},r.onRemoteStream=function(e,o){console.log("stream started"),window.w5capi_SIP.emit("SIP-remotestream",{stream:o})},r.onError=function(e){console.error("ERROR:",e),a.hangup({cause:"Device or Permission Error"})},a.rtc=new e.FSRTC({callbacks:r,localVideo:a.screenShare?null:a.localVideo,useVideo:a.params.useVideo?a.videoStream:null,useAudio:a.audioStream,useStereo:a.params.useStereo,videoParams:a.params.videoParams,audioParams:t.options.audioParams,iceServers:t.options.iceServers,screenShare:a.screenShare,useCamera:a.useCamera,useMic:a.useMic,useSpeak:a.useSpeak}),a.rtc.verto=a.verto,a.direction==e.verto["enum"].direction.inbound&&(a.attach?a.answer():a.ring())},e.verto.dialog.prototype.invite=function(){var e=this;e.rtc.call()},e.verto.dialog.prototype.sendMethod=function(e,o){var t=this;o.dialogParams={};for(var n in t.params)("sdp"!=n||"verto.invite"==e||"verto.attach"==e)&&(o.dialogParams[n]=t.params[n]);t.verto.rpcClient.call(e,o,function(o){t.processReply(e,!0,o)},function(o){t.processReply(e,!1,o)})},e.verto.dialog.prototype.setAudioPlaybackDevice=function(e,o,t){var n=this,a=n.audioStream;if("undefined"!=typeof a.sinkId){var r=s(e);console.info("Dialog: "+n.callID+" Setting speaker:",a,r),a.setSinkId(e).then(function(){console.log("Dialog: "+n.callID+" Success, audio output device attached: "+e),o&&o(!0,r,t)})["catch"](function(e){var a=e;"SecurityError"===e.name&&(a="Dialog: "+n.callID+" You need to use HTTPS for selecting audio output device: "+e),o&&o(!1,null,t),console.error(a)})}else console.warn("Dialog: "+n.callID+" Browser does not support output device selection."),o&&o(!1,null,t)},e.verto.dialog.prototype.setState=function(o){var t=this;if(t.state==e.verto["enum"].state.ringing&&t.stopRinging(),t.state==o||!r(t.state,o))return console.error("Dialog "+t.callID+": INVALID state change from "+t.state.name+" to "+o.name),t.hangup(),!1;switch(console.log("Dialog "+t.callID+": state change from "+t.state.name+" to "+o.name),t.lastState=t.state,t.state=o,t.causeCode||(t.causeCode=16),t.cause||(t.cause="NORMAL CLEARING"),t.callbacks.onDialogState&&t.callbacks.onDialogState(this),t.state){case e.verto["enum"].state.early:case e.verto["enum"].state.active:var n=t.useSpeak;console.info("Using Speaker: ",n),n&&"any"!==n&&setTimeout(function(){t.setAudioPlaybackDevice(n)},500);break;case e.verto["enum"].state.trying:setTimeout(function(){t.state==e.verto["enum"].state.trying&&t.setState(e.verto["enum"].state.hangup)},3e4);break;case e.verto["enum"].state.purge:t.setState(e.verto["enum"].state.destroy);break;case e.verto["enum"].state.hangup:t.lastState.val>e.verto["enum"].state.requesting.val&&t.lastState.val<e.verto["enum"].state.hangup.val&&t.sendMethod("verto.bye",{}),t.setState(e.verto["enum"].state.destroy);break;case e.verto["enum"].state.destroy:delete t.verto.dialogs[t.callID],t.params.screenShare?t.rtc.stopPeer():t.rtc.stop()}return!0},e.verto.dialog.prototype.processReply=function(o,t,n){var a=this;switch(o){case"verto.answer":case"verto.attach":t?a.setState(e.verto["enum"].state.active):a.hangup();break;case"verto.invite":t?a.setState(e.verto["enum"].state.trying):a.setState(e.verto["enum"].state.destroy);break;case"verto.bye":a.hangup();break;case"verto.modify":n.holdState&&("held"==n.holdState?a.state!=e.verto["enum"].state.held&&a.setState(e.verto["enum"].state.held):"active"==n.holdState&&a.state!=e.verto["enum"].state.active&&a.setState(e.verto["enum"].state.active))}},e.verto.dialog.prototype.hangup=function(o){var t=this;o&&(o.causeCode&&(t.causeCode=o.causeCode),o.cause&&(t.cause=o.cause)),t.state.val>=e.verto["enum"].state["new"].val&&t.state.val<e.verto["enum"].state.hangup.val?t.setState(e.verto["enum"].state.hangup):t.state.val<e.verto["enum"].state.destroy&&t.setState(e.verto["enum"].state.destroy)},e.verto.dialog.prototype.stopRinging=function(){var e=this;e.verto.ringer&&e.verto.ringer.stop()},e.verto.dialog.prototype.indicateRing=function(){var o=this;o.verto.ringer&&(o.verto.ringer.attr("src",o.verto.options.ringFile)[0].play(),setTimeout(function(){o.stopRinging(),o.state==e.verto["enum"].state.ringing&&o.indicateRing()},o.verto.options.ringSleep))},e.verto.dialog.prototype.ring=function(){var o=this;o.setState(e.verto["enum"].state.ringing),o.indicateRing()},e.verto.dialog.prototype.useVideo=function(e){var o=this;o.params.useVideo=e,e?o.videoStream=o.audioStream:o.videoStream=null,o.rtc.useVideo(o.videoStream,o.localVideo)},e.verto.dialog.prototype.setMute=function(e){var o=this;return o.rtc.setMute(e)},e.verto.dialog.prototype.getMute=function(){var e=this;return e.rtc.getMute()},e.verto.dialog.prototype.setVideoMute=function(e){var o=this;return o.rtc.setVideoMute(e)},e.verto.dialog.prototype.getVideoMute=function(){var e=this;return e.rtc.getVideoMute()},e.verto.dialog.prototype.useStereo=function(e){var o=this;o.params.useStereo=e,o.rtc.useStereo(e)},e.verto.dialog.prototype.dtmf=function(e){var o=this;e&&o.sendMethod("verto.info",{dtmf:e})},e.verto.dialog.prototype.transfer=function(e,o){var t=this;e&&t.sendMethod("verto.modify",{action:"transfer",destination:e,params:o})},e.verto.dialog.prototype.hold=function(e){var o=this;o.sendMethod("verto.modify",{action:"hold",params:e})},e.verto.dialog.prototype.unhold=function(e){var o=this;o.sendMethod("verto.modify",{action:"unhold",params:e})},e.verto.dialog.prototype.toggleHold=function(e){var o=this;o.sendMethod("verto.modify",{action:"toggleHold",params:e})},e.verto.dialog.prototype.message=function(e){var o=this,t=0;return e.from=o.params.login,e.to||(console.error("Missing To"),t++),e.body||(console.error("Missing Body"),t++),t?!1:(o.sendMethod("verto.info",{msg:e}),!0)},e.verto.dialog.prototype.answer=function(e){var o=this;o.answered||(e||(e={}),e.sdp=o.params.sdp,e&&(e.useVideo&&o.useVideo(!0),o.params.callee_id_name=e.callee_id_name,o.params.callee_id_number=e.callee_id_number,e.useCamera&&(o.useCamera=e.useCamera),e.useMic&&(o.useMic=e.useMic),e.useSpeak&&(o.useSpeak=e.useSpeak)),o.rtc.createAnswer(e),o.answered=!0)},e.verto.dialog.prototype.handleAnswer=function(o){var t=this;t.gotAnswer=!0,t.state.val>=e.verto["enum"].state.active.val||(t.state.val>=e.verto["enum"].state.early.val?t.setState(e.verto["enum"].state.active):t.gotEarly?console.log("Dialog "+t.callID+" Got answer while still establishing early media, delaying..."):(console.log("Dialog "+t.callID+" Answering Channel"),t.rtc.answer(o.sdp,function(){t.setState(e.verto["enum"].state.active)},function(e){console.error(e),t.hangup()}),console.log("Dialog "+t.callID+"ANSWER SDP",o.sdp)))},e.verto.dialog.prototype.cidString=function(e){var o=this,t=o.params.remote_caller_id_name+(e?" &lt;":" <")+o.params.remote_caller_id_number+(e?"&gt;":">");return t},e.verto.dialog.prototype.sendMessage=function(e,o){var t=this;t.callbacks.onMessage&&t.callbacks.onMessage(t.verto,t,e,o)},e.verto.dialog.prototype.handleInfo=function(o){var t=this;t.sendMessage(e.verto["enum"].message.info,o.msg)},e.verto.dialog.prototype.handleDisplay=function(o){var t=this;o.display_name&&(t.params.remote_caller_id_name=o.display_name),o.display_number&&(t.params.remote_caller_id_number=o.display_number),t.sendMessage(e.verto["enum"].message.display,{})},e.verto.dialog.prototype.handleMedia=function(o){var t=this;t.state.val>=e.verto["enum"].state.early.val||(t.gotEarly=!0,t.rtc.answer(o.sdp,function(){console.log("Dialog "+t.callID+"Establishing early media"),t.setState(e.verto["enum"].state.early),t.gotAnswer&&(console.log("Dialog "+t.callID+"Answering Channel"),t.setState(e.verto["enum"].state.active))},function(e){console.error(e),t.hangup()}),console.log("Dialog "+t.callID+"EARLY SDP",o.sdp))},e.verto.ENUM=function(e){var o=0,t={};return e.split(" ").map(function(e){t[e]={name:e,val:o++}}),Object.freeze(t)},e.verto["enum"]={},e.verto["enum"].states=Object.freeze({"new":{requesting:1,recovering:1,ringing:1,destroy:1,answering:1,hangup:1},requesting:{trying:1,hangup:1,active:1},recovering:{answering:1,hangup:1},trying:{active:1,early:1,hangup:1},ringing:{answering:1,hangup:1},answering:{active:1,hangup:1},active:{answering:1,requesting:1,hangup:1,held:1},held:{hangup:1,active:1},early:{hangup:1,active:1},hangup:{destroy:1},destroy:{},purge:{destroy:1}}),e.verto["enum"].state=e.verto.ENUM("new requesting trying recovering ringing answering early active held hangup destroy purge"),e.verto["enum"].direction=e.verto.ENUM("inbound outbound"),e.verto["enum"].message=e.verto.ENUM("display info pvtEvent"),e.verto["enum"]=Object.freeze(e.verto["enum"]),e.verto.saved=[],e.verto.unloadJobs=[],e(window).bind("beforeunload",function(){for(var o in e.verto.unloadJobs)e.verto.unloadJobs[o]();for(var t in e.verto.saved){var n=e.verto.saved[t];n&&(n.purge(),n.logout())}return e.verto.warnOnUnload}),e.verto.videoDevices=[],e.verto.audioInDevices=[],e.verto.audioOutDevices=[];var p=function(o){console.info("enumerating devices");var t=[],n=[],a=[];if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices||!MediaStreamTrack.getSources){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return void console.log("enumerateDevices() not supported.");navigator.mediaDevices.enumerateDevices().then(function(r){r.forEach(function(e){console.log(e),console.log(e.kind+": "+e.label+" id = "+e.deviceId),"videoinput"===e.kind?a.push({id:e.deviceId,kind:"video",label:e.label}):"audioinput"===e.kind?t.push({id:e.deviceId,kind:"audio_in",label:e.label}):"audiooutput"===e.kind&&n.push({id:e.deviceId,kind:"audio_out",label:e.label})}),e.verto.videoDevices=a,e.verto.audioInDevices=t,e.verto.audioOutDevices=n,console.info("Audio IN Devices",e.verto.audioInDevices),console.info("Audio Out Devices",e.verto.audioOutDevices),console.info("Video Devices",e.verto.videoDevices),o(!0)})["catch"](function(e){console.log(" Device Enumeration ERROR: "+e.name+": "+e.message),o(!1)})}else MediaStreamTrack.getSources(function(n){for(var r=0;r<n.length;r++)"video"==n[r].kind?a.push(n[r]):t.push(n[r]);e.verto.videoDevices=a,e.verto.audioInDevices=t,console.info("Audio Devices",e.verto.audioInDevices),console.info("Video Devices",e.verto.videoDevices),o(!0)})};e.verto.refreshDevices=function(e){p(e)},e.verto.init=function(o,t){o||(o={}),o.skipPermCheck||o.skipDeviceCheck?o.skipPermCheck&&!o.skipDeviceCheck?p(t):!o.skipPermCheck&&o.skipDeviceCheck?e.FSRTC.checkPerms(function(e){t(e)},!0,!0):t(null):e.FSRTC.checkPerms(function(e){p(t)},!0,!0)},e.verto.genUUID=function(){return i()}}(jQuery);
